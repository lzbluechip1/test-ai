name: AI Terraform Review

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Zip Terraform
        run: |
          ZIP=$(python scripts/zip_terraform.py)
          echo "ZIP=$ZIP" >> $GITHUB_ENV

      - name: Send to AI Agent
        id: ai
        run: |
          RESPONSE=$(curl -s -X POST \
            https://pseudoministerial-declaratively-dortha.ngrok-free.dev/review \
            -H "Content-Type: application/json" \
            -d '{"terraform_files_base64":"'"$ZIP"'"}')

          echo "$RESPONSE"
          echo "decision=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Enforce Decision
        run: |
          STATUS=$(echo '${{ steps.ai.outputs.decision }}' | jq -r '.status')

          if [ "$STATUS" != "APPROVE" ]; then
            echo "❌ AI blocked Terraform"
            exit 1
          fi

          echo "✅ Terraform approved"

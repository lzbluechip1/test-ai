name: AI Terraform Review   

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # -------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------
      # 2Ô∏è‚É£ Setup Python
      # -------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------
      # 3Ô∏è‚É£ Zip Terraform directory
      # -------------------------------
      - name: Zip Terraform
        id: zip
        run: |
          ZIP=$(python scripts/zip_terraform.py)
          echo "terraform_zip=$ZIP" >> $GITHUB_OUTPUT
      # install jq
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # -------------------------------
      # 4Ô∏è‚É£ Call AI Orchestrator
      # -------------------------------
      - name: Send Terraform to AI Agent
        id: ai
        run: |
          echo "üì° Sending Terraform to AI..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://pseudoministerial-declaratively-dortha.ngrok-free.dev/review \
            -H "Content-Type: application/json" \
            -d "{\"terraform_files_base64\":\"${{ steps.zip.outputs.terraform_zip }}\"}")

          BODY=$(echo "$RESPONSE" | head -n 1)
          CODE=$(echo "$RESPONSE" | tail -n 1)

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "status_code=$CODE" >> $GITHUB_OUTPUT

      # -------------------------------
      #  Print AI Response (Always)
      # -------------------------------
      - name: Show AI Response
        run: |
            echo "================ AI RESPONSE ================"
            echo "HTTP Status Code: ${{ steps.ai.outputs.status_code }}"
            echo ""
            echo '${{ steps.ai.outputs.response }}'
            echo "============================================"
            
      - name: Show AI Response (Pretty JSON)
        run: |
          echo "================ AI RESPONSE ================"
          echo "HTTP Status Code: ${{ steps.ai.outputs.status_code }}"
          echo ""

          echo '${{ steps.ai.outputs.response }}' | jq .

          echo "============================================"

      # -------------------------------
      #  Enforce AI Decision (SAFE)
      # -------------------------------
      - name: Enforce AI Decision
        run: |
          STATUS=$(echo '${{ steps.ai.outputs.response }}' | jq -r .status)

          if [ "$STATUS" != "STABLE" ]; then
            echo "‚ùå AI blocked Terraform (status=$STATUS)"
            exit 1
          fi

          echo "‚úÖ Terraform approved by AI"
          
      - name: Enforce AI Decision111
        run: |
          python - <<'EOF'
          import json, sys

          raw = """${{ steps.ai.outputs.response }}"""
          code = int("${{ steps.ai.outputs.status_code }}")

          if code != 200:
              print("‚ùå AI service failed (HTTP", code, ")")
              sys.exit(1)

          try:
              data = json.loads(raw)
          except Exception:
              print("‚ùå AI response is not valid JSON")
              print(raw)
              sys.exit(1)

          status = data.get("status")
          summary = data.get("summary")
          confidence = data.get("confidence")

          print("üß† AI Status    :", status)
          print("üìã Summary      :", summary)
          print("üéØ Confidence   :", confidence)

          if status != "UNSATISFACTORY":
              print("‚ùå AI BLOCKED this change")
              sys.exit(1)

          print("‚úÖ AI APPROVED Terraform")
          EOF
